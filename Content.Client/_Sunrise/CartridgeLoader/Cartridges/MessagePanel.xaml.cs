using Content.Client._Sunrise.Messenger;
using Content.Client.Resources;
using Content.Shared._Sunrise.Messenger;
using Robust.Client.AutoGenerated;
using Robust.Client.GameObjects;
using Robust.Client.Graphics;
using Robust.Client.ResourceManagement;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.RichText;
using Robust.Client.UserInterface.XAML;
using Robust.Shared.Utility;

namespace Content.Client._Sunrise.CartridgeLoader.Cartridges;

[GenerateTypedNameReferences]
public sealed partial class MessagePanel : PanelContainer
{
    [Dependency] private readonly IResourceCache _resourceCache = default!;
    [Dependency] private readonly IEntitySystemManager _entitySystemManager = default!;

    private ClientEmojiSystem? EmojiSystem => _entitySystemManager.GetEntitySystemOrNull<ClientEmojiSystem>();
    private SpriteSystem GetSpriteSystem() => _entitySystemManager.GetEntitySystem<SpriteSystem>();

    private static readonly Type[] MessageTagsAllowed =
    [
        typeof(BoldItalicTag),
        typeof(BoldTag),
        typeof(BulletTag),
        typeof(ColorTag),
        typeof(HeadingTag),
        typeof(ItalicTag),
        typeof(EmojiTag),
    ];

    public MessagePanel()
    {
        IoCManager.InjectDependencies(this);
        RobustXamlLoader.Load(this);
    }

    public void UpdateMessage(MessengerMessage message, bool isOwnMessage, bool isPersonalChat, string? currentUserId)
    {
        SenderLabel.Text = message.SenderName;
        TimeLabel.Text = message.Timestamp.ToString(@"hh\:mm");

        var parsedContent = EmojiSystem?.ParseEmojis(message.Content) ?? message.Content;
        ContentLabel.SetMessage(FormattedMessage.FromMarkupPermissive(parsedContent), MessageTagsAllowed);

        var roundedButtonTex = _resourceCache.GetTexture("/Textures/Interface/Nano/rounded_button_bordered.svg.96dpi.png");
        var roundedStyleBox = new StyleBoxTexture
        {
            Texture = roundedButtonTex
        };
        roundedStyleBox.SetPatchMargin(StyleBox.Margin.All, 5);
        roundedStyleBox.SetPadding(StyleBox.Margin.All, 2);
        roundedStyleBox.SetContentMarginOverride(StyleBox.Margin.Left, 8);
        roundedStyleBox.SetContentMarginOverride(StyleBox.Margin.Right, 8);
        roundedStyleBox.SetContentMarginOverride(StyleBox.Margin.Top, 6);
        roundedStyleBox.SetContentMarginOverride(StyleBox.Margin.Bottom, 6);

        if (isOwnMessage)
        {
            roundedStyleBox.Modulate = Color.FromHex("#2A4A5A");
        }
        else
        {
            roundedStyleBox.Modulate = Color.FromHex("#1E1E22");
        }

        MessagePanelContainer.PanelOverride = roundedStyleBox;

        if (isPersonalChat && isOwnMessage && message.RecipientId != null)
        {
            ReadStatusIcon.Visible = true;
            var readStatusTexturePath = message.IsRead
                ? new ResPath("/Textures/Interface/Actions/eyeopen.png")
                : new ResPath("/Textures/Interface/Actions/eyeclose.png");
            ReadStatusIcon.Texture = _resourceCache.GetTexture(readStatusTexturePath);
        }
        else
        {
            ReadStatusIcon.Visible = false;
        }
    }
}
